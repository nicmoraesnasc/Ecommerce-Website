<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}"/>
    <title>Update {{ name }}</title>
</head>
<body>
    <div class="form-group5">
        {% include 'header/index.html' %}
    
        <form id="updateForm" action="{{ url_for('update_user', id=id) }}" method="POST">
            {% if error %}
                <div class="error-message" style="color: red; margin-bottom: 15px;">
                    {{ error }}
                </div>
            {% endif %}

            <div id="password-mismatch" class="error-message" style="color: red; margin-bottom: 15px; display: none;">
                As senhas não coincidem.
            </div>

            <label for="name">Nome: </label>
            <input type="text" name="name" id="name" value="{{ name }}"><br>

            <label for="last_name">Sobrenome: </label>
            <input type="text" name="last_name" id="last_name" value="{{ last_name }}"><br>

            <label for="phone">Telefone: </label>
            <input type="text" name="phone" id="phone" value="{{ phone }}"><br>

            <label for="email">E-mail: </label>
            <input type="email" name="email" id="email" value="{{ email }}"><br>

            <label for="state">Estado: </label>
            <input type="text" name="state" id="state" value="{{ state }}"><br>

            <label for="city">Cidade: </label>
            <input type="text" name="city" id="city" value="{{ city }}"><br>

            <label for="zip_code">CEP: </label>
            <input type="text" name="zip_code" id="zip_code" value="{{ zip_code }}"><br>

            <label for="neighborhood">Bairro: </label>
            <input type="text" name="neighborhood" id="neighborhood" value="{{ neighborhood }}"><br>

            <label for="address">Endereço: </label>
            <input type="text" name="address" id="address" value="{{ address }}"><br>

            <label for="house_number">Número: </label>
            <input type="number" name="house_number" id="house_number" value="{{ house_number }}"><br>

            <label for="password">Senha: </label>
            <input type="password" name="password" id="password" placeholder="Deixe em branco para manter a senha atual"><br>

            <label for="password_c">Confirme sua senha: </label>
            <input type="password" name="password_c" id="password_c" placeholder="Deixe em branco para manter a senha atual"><br>

            <button type="submit" class="button-save-profile">Salvar perfil</button>
        </form>
    </div>

    <script>
    document.getElementById('updateForm').addEventListener('submit', function(e) {
        console.log('Formulário tentando enviar...');
        
        const password = document.getElementById('password').value;
        const password_c = document.getElementById('password_c').value;
        const errorMsg = document.getElementById('password-mismatch');
        
        console.log('Senha:', password);
        console.log('Confirmação:', password_c);
        
        if (password !== '' && password_c !== '' && password !== password_c) {
            console.log('Senhas não coincidem - mostrando erro');
            errorMsg.style.display = 'block';
            e.preventDefault();
            return false;
        }
        
        console.log('Senhas OK - enviando formulário');
        return true;
    });

    document.getElementById('password').addEventListener('input', checkPasswords);
    document.getElementById('password_c').addEventListener('input', checkPasswords);

    function checkPasswords() {
        const password = document.getElementById('password').value;
        const password_c = document.getElementById('password_c').value;
        const errorMsg = document.getElementById('password-mismatch');
        
        if (password !== '' && password_c !== '' && password !== password_c) {
            errorMsg.style.display = 'block';
        } else {
            errorMsg.style.display = 'none';
        }
    }

    // CEP
    document.getElementById('zip_code').addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                if (!data.erro) {
                    document.getElementById('state').value = data.uf;
                    document.getElementById('city').value = data.localidade;
                    document.getElementById('neighborhood').value = data.bairro;
                    document.getElementById('address').value = data.logradouro;
                }
            })
            .catch(() => console.log('Erro ao consultar CEP'));
        }
    });
    </script>
</body>
</html>
